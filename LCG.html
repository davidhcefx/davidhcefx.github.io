<!DOCTYPE html>
<html lang="en">
<head>
  <title>Crypto: Linear Congruential Generator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Cracking Linear Congruential Generator (CTF Wargame)">
  <link href="res/favicon.ico" rel="icon">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
  <script src='src/md5.js'></script>
  <style>
    code, pre {
      font-size: 16px;
    }
    code {
      /*font-weight: bold;*/
    }
    .Highlight {
      background-color: #fffbe5;
    }
    .Inline-box {
      border: none;
      background-color: aliceblue;
      text-align: center;
      font-size: 16px;
      font-family: monospace;
    }
    #playground {
      float: right;
      border-style: ridge;
      width: 40%;
      max-width: 370px;
      padding: 0 2% 2% 2%;
    }
    #compute-btn {
      float: right;
      width: 44px;
    }
    #result {
      width: 100%;
    }
  </style>
</head>
<body>

  <h1>Linear Congruential Generator</h1>
  <hr>

  <p>The formula is as follows:</p>
  <pre>
function f(Si) {
  return (a * Si + b) mod N
}</pre>

  <p>
    Basically, <code>a</code>, <code>b</code>, and <code>N</code> are the coefficients of the Random Number Generator (RNG).<br>
    In round 1, <code>S1</code> will be plugged in, producing output <code>S2</code>, which will then be the input of round 2. By gathering all the outputs, we will have a sequence of random numbers.
  </p>
  <p>
    The question is, can we crack this RNG? That is, can we find out the coefficients <code>a</code>, <code>b</code>, and <code>N</code> by simply observing the generated outputs? Let's check it out:
  </p>
  <hr>

  <div id="playground">
    <h3>Playground</h3>
    <p>
      Compute
      <code>
        (<input type="text" id="a" value="2" class="Inline-box" style="width: 8.9px" onkeyup="autoscale(this)">
        *
        <input type="text" id="Si" value="1" class="Inline-box" style="width: 8.9px" onkeyup="autoscale(this)">
        +
        <input type="text" id="b" value="7" class="Inline-box" style="width: 8.9px" onkeyup="autoscale(this)">)
        mod
        <input type="text" id="N" value="23" class="Inline-box" style="width: 17.8px" onkeyup="autoscale(this)">:
      </code>
      <input type="button" id="compute-btn" value="Go" onclick="compute()">
    </p>
    <textarea id="result" rows="8"></textarea>
  </div>

  <p>1. We already leaked two of them, <code class="Highlight">&nbsp;a = 12349876 </code> and <code class="Highlight">&nbsp;N = 43216789 </code>, please help us figure out <code>b</code> :</p>
  <p>These are the outputs we gathered:<br>
  <code>
    &emsp; Si&nbsp;&nbsp; = 34425850<br>
    &emsp; Si+1 = 19828421<br>
    &emsp; Si+2 = 40149722
  </code></p>
  <p>Once we figured out <code>b</code>, ALL the consecutive numbers generated would no no longer be "random" anymore!<br>
  If you think you've cracked it, please provide the next random number.</p>
  <code>&emsp; Si+3 = <input type="text" size="9" id="ans_1"></code> <input type="button" value="Check" onclick="check_1()">&emsp;<span id="check_res_1"></span>
  <br>
  <br>
  <br>
  <br>
  <br>
  <hr>

  <p>2. This time, we only leaked <code class="Highlight">&nbsp;N = 87879487 </code>, but I think it is still crackable!</p>
  <p>Again, we have gathered some outputs:<br>
  <code>
    &emsp; Si&nbsp;&nbsp; = 30296335<br>
    &emsp; Si+1 = 60248031<br>
    &emsp; Si+2 = 23522917
  </code></p>
  <p>If you think you've cracked it, please provide the next random number:</p>
  <code>&emsp; Si+3 = <input type="text" size="9" id="ans_2"></code> <input type="button" value="Check" onclick="check_2()">&emsp;<span id="check_res_2"></span>
  <br>
  <br>
  <br>
  <br>
  <br>
  <hr>
  
  <!--  solvable ?
  67702636
  36138443
  62326253
  68578233
  80610932
  12711352
  91694468 -->
  <br>
  <br>
  <br>
  <br>
  <br>

  <script>
    function autoscale(element) {
      // each digits uses up ~ 8.9px
      element.style.width = `${element.value.length * 8.9}px`;
    }

    function compute() {
      const a = parseInt($('#a')[0].value);
      const b = parseInt($('#b')[0].value);
      const N = parseInt($('#N')[0].value);
      const Si_elem = $('#Si')[0];
      const res = (a * parseInt(Si_elem.value) + b) % N;
      $('#result')[0].value += `${res}\n`;
      // set result to next Si
      Si_elem.value = res;
      autoscale(Si_elem);
    }

    /* xor two hex strings */
    function xor(hex1, hex2) {
      let res = "";
      for (let i = 0; i < hex1.length; i += 4) {  // parse each 2 bytes
        const a = parseInt(hex1.substring(i, i + 4), 16);
        const b = parseInt(hex2.substring(i, i + 4), 16);
        res += (a ^ b).toString(16).padStart(4, '0');
      }
      return res;
    }

    /* convert ascii to hex string */
    function stoh(str) {
      let res = "";
      str.split('').forEach(s => {
        res += s.charCodeAt().toString(16);
      })
      return res;
    }

    /* convert hex string to ascii */
    function htos(hex) {
      let res = "";
      let octate_buf = [];  // collect two octates to form one byte
      hex.split('').forEach(h => {
        if (octate_buf.length == 0) {
          octate_buf.push(h);
        } else {
          res += String.fromCharCode(parseInt(octate_buf.pop() + h, 16));
        }
      });
      return res;
    }

    function check_1() {
      const ans = md5(`${$('#ans_1')[0].value}527b59b958f5359a2d38414d`);
      const key = md5(`${$('#ans_1')[0].value}2384ebc68c1f014064cc3442`);
      const msg = (ans === "ce4964edab6dc88198e913c9b1eb29bc") ?
        htos(
          xor(
            "43070a0beb30086682b241e783c7ab8370262621f2365354d8b702e680aa9c8b",
            key + key)) :
        "Uh...Nope!";

      $('#check_res_1')[0].innerText = msg;
    }

    function check_2() {
      const ans = md5(`${$('#ans_2')[0].value}7b3d3bdcc16607bfc4011dbd`);
      const key = md5(`${$('#ans_2')[0].value}a85b21a2620e31d0f938b120`);
      const msg = (ans === "34e618f23bfb66ac310307497237af53") ?
        htos(
          xor(
            "ab46259a7a6a1807bfa750d86715c966de3916e864402a5c85e216b769449e28",
            key + key)) :
        "Not this one!";

      $('#check_res_2')[0].innerText = msg;
    }

    function check_3() {
      const ans = md5(`${$('#ans_3')[0].value}9738c93165519764628bb872`);
      const key = md5(`${$('#ans_3')[0].value}7fc618db0df41c2ebd27d430`);
      const msg = (ans === "ee01a553f0fadefc819002ce40245b6e") ?
        htos(
          xor(
            "7b915d5decf4c0f7607a63cc44c6e44c0cea7445d8c8a69d136650ce43978846",
            key + key)) :
        "Try again!";

      $('#check_res_3')[0].innerText = msg;
    }
  </script>
</body>
</html>
